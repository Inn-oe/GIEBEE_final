{% extends "base.html" %}

{% block title %}Create Invoice - Giebee Engineering{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">Create Invoice</h1>
    <a href="{{ url_for('invoices') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Invoices
    </a>
</div>

<form method="POST">
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Customer</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customer_identification" class="form-label">Customer Identification Number *</label>
                                <input type="text" class="form-control" id="customer_identification" name="customer_identification" required list="customer-list">
                                <datalist id="customer-list">
                                    {% for customer in customers %}
                                    <option value="{{ customer.identification_number }}">{{ customer.name }} - {{ customer.identification_number }}</option>
                                    {% endfor %}
                                </datalist>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customer_name_display" class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="customer_name_display" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Items</h5>
                </div>
                <div class="card-body">
                    <div id="invoice-items">
                        <div class="row invoice-item align-items-end mb-3">
                            <div class="col-md-2">
                                <label class="form-label">Item</label>
                                <select class="form-select item-select" name="item_id[]" required onchange="updatePrice(this)">
                                    <option value="">Select Item</option>
                                    {% for item in inventory_items %}
                                    <option value="{{ item.id }}" data-price="{{ item.unit_price }}">{{ item.name }} ({{ item.quantity }} available)</option>
                                    {% endfor %}
                                    <option value="custom">Custom Item (Not in Stock)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity[]" min="1" required oninput="calculateItemTotal(this)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control unit-price" name="unit_price[]" required oninput="calculateItemTotal(this)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Item Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control item-total" readonly value="0.00">
                                </div>
                            </div>
                            <div class="col-md-2 custom-item-fields" style="display: none;">
                                <label class="form-label">Custom Item Name</label>
                                <input type="text" class="form-control custom-item-name" name="custom_item_name[]" placeholder="Enter item name">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                    <i class="fas fa-trash me-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addItem()">
                        <i class="fas fa-plus me-2"></i>Add Another Item
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card position-sticky" style="top: 2rem;">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Total:</h5>
                        <h3 id="invoice-total" class="mb-0 fw-bold">$0.00</h3>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Create Invoice</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
const inventory = {
{% for item in inventory_items %}
    "{{ item.id }}": {
        name: "{{ item.name | e }}",
        price: "{{ item.unit_price }}",
        quantity: "{{ item.quantity }}"
    }{% if not loop.last %},{% endif %}
{% endfor %}
};

function createItemRow() {
    const itemRow = document.createElement('div');
    itemRow.className = 'row invoice-item align-items-end mb-3';
    itemRow.innerHTML = `
        <div class="col-md-2">
            <label class="form-label">Item</label>
            <select class="form-select item-select" name="item_id[]" required onchange="updatePrice(this)">
                <option value="">Select Item</option>
                ${Object.keys(inventory).map(id => `<option value="${id}" data-price="${inventory[id].price}">${inventory[id].name.replace(/"/g, '"')} (${inventory[id].quantity} available)</option>`).join('')}
                <option value="custom">Custom Item (Not in Stock)</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" name="quantity[]" min="1" required oninput="calculateItemTotal(this)">
        </div>
        <div class="col-md-2">
            <label class="form-label">Unit Price</label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" class="form-control unit-price" name="unit_price[]" required oninput="calculateItemTotal(this)">
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label">Item Total</label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control item-total" readonly value="0.00">
            </div>
        </div>
        <div class="col-md-2 custom-item-fields" style="display: none;">
            <label class="form-label">Custom Item Name</label>
            <input type="text" class="form-control custom-item-name" name="custom_item_name[]" placeholder="Enter item name">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                <i class="fas fa-trash me-1"></i>Remove
            </button>
        </div>
    `;
    return itemRow;
}

function addItem() {
    document.getElementById('invoice-items').appendChild(createItemRow());
}

function removeItem(button) {
    const itemContainer = document.getElementById('invoice-items');
    if (itemContainer.children.length > 1) {
        button.closest('.invoice-item').remove();
        calculateGrandTotal();
    }
}

function updatePrice(select) {
    const selectedValue = select.value;
    const priceInput = select.closest('.invoice-item').querySelector('.unit-price');
    const customFields = select.closest('.invoice-item').querySelector('.custom-item-fields');

    if (selectedValue === 'custom') {
        priceInput.value = '';
        customFields.style.display = 'block';
        priceInput.required = true;
    } else {
        const price = select.options[select.selectedIndex].dataset.price;
        priceInput.value = price || '';
        customFields.style.display = 'none';
        priceInput.required = true;
    }
    calculateItemTotal(select);
}

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('item-select')) {
        updatePrice(e.target);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('customer_identification').addEventListener('input', function() {
        const inputValue = this.value;
        const datalist = document.getElementById('customer-list');
        const options = datalist.options;
        let customerName = '';

        for (let i = 0; i < options.length; i++) {
            if (options[i].value === inputValue) {
                customerName = options[i].textContent.split(' - ')[0];
                break;
            }
        }

        document.getElementById('customer_name_display').value = customerName;
    });
});

function calculateItemTotal(element) {
    const itemRow = element.closest('.invoice-item');
    const quantity = parseFloat(itemRow.querySelector('input[name="quantity[]"]').value) || 0;
    const price = parseFloat(itemRow.querySelector('.unit-price').value) || 0;
    const itemTotal = quantity * price;
    itemRow.querySelector('.item-total').value = itemTotal.toFixed(2);
    calculateGrandTotal();
}

function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.invoice-item').forEach(item => {
        const quantity = parseFloat(item.querySelector('input[name="quantity[]"]').value) || 0;
        const price = parseFloat(item.querySelector('.unit-price').value) || 0;
        total += quantity * price;
    });
    document.getElementById('invoice-total').textContent = '$' + total.toFixed(2);
}
</script>
{% endblock %}
